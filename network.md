# network

## Установка TCP соединения

1. Клиент SYN - случайный начальный номер последовательности (sequence number), максимальный размер сегмента (maximum segment size)
2. Сервер SYN/ACK - случайный начальный номер последовательности (sequence number), максимальный размер сегмента (maximum segment size), номер последовательности клиента +1
3. Клиент ACK - номер последовательности сервера +1

### содержимое TCP

- Номер последовательности, который определяет позицию сегмента в потоке данных
- Номер подтверждения, который определяет номер следующего ожидаемого сегмента от другой стороны.
- Размер окна, который определяет количество байтов, которые можно принять без подтверждения.
- Контрольная сумма, которая служит для проверки целостности данных.
- Флаги, которые указывают на различные состояния и команды, такие как FIN (finish), RST (reset), PSH (push) и URG (urgent).

Каждый полученный сегмент должен быть подтвержден отправкой сегмента с флагом ACK и соответствующим номером подтверждения. Если сегмент не был получен или был поврежден, то отправитель повторяет его отправку до получения подтверждения. Если сегменты приходят в неправильном порядке, то они буферизуются до тех пор, пока не будет получен недостающий сегмент.
Для завершения соединения между клиентом и сервером используется четырехстороннее рукопожатие (four-way handshake), которое состоит из четырех шагов:

- Одна из сторон отправляет другой сегмент с флагом FIN
- Другая сторона подтверждает получение сегмента с флагом FIN, отправляя сегмент с флагом ACK.
- Другая сторона также отправляет свой сегмент с флагом FIN, если она больше не хочет передавать данные.
- Первая сторона подтверждает получение сегмента с флагом FIN, отправляя сегмент с флагом ACK.

### TLS connection

Процесс установки TLS соединения состоит из двух фаз: согласования параметров и обмена ключами. Вот как это работает:

#### Согласование параметров

1. Клиент отправляет серверу сообщение ClientHello, которое содержит следующую информацию:
   - Версия TLS, которую поддерживает клиент.
   - Список наборов шифров, которые предпочитает клиент.
   - Случайное число, которое будет использоваться для генерации ключей.
   - Список расширений, которые поддерживает клиент.
2. Сервер, получив сообщение ClientHello, выбирает наиболее подходящую версию TLS, набор шифров и расширения из предложенных клиентом. Затем сервер отправляет клиенту сообщение ServerHello, которое содержит следующую информацию:
   - Версия TLS, которую согласовал сервер.
   - Набор шифров, который согласовал сервер.
   - Случайное число, которое будет использоваться для генерации ключей.
   - Список расширений, которые согласовал сервер.
   - Сервер также отправляет клиенту свой сертификат, который содержит его публичный ключ и подтверждает его идентичность. Клиент проверяет валидность сертификата с помощью доверенных центров сертификации или других механизмов. Если сертификат действителен, клиент продолжает установку соединения. Если нет, клиент прерывает соединение и выдает ошибку.

#### Обмен ключами

1. Клиент генерирует предварительный мастер-ключ (premaster secret), который будет использоваться для создания сеансовых ключей для шифрования данных. Клиент шифрует предварительный мастер-ключ публичным ключом сервера (из SSL сертификата сервера) и отправляет его серверу в сообщении ClientKeyExchange.
2. Сервер дешифрует предварительный мастер-ключ своим приватным ключом и получает тот же самый ключ, что и клиент.
3. Клиент и сервер используют предварительный мастер-ключ и случайные числа, обменянные ранее, для вычисления мастер-ключа (master secret), который является общим секретом между ними. Затем они используют мастер-ключ для генерации сеансовых ключей для шифрования и дешифрования данных, а также для вычисления кодов аутентификации сообщений (MAC), которые служат для проверки целостности данных.
4. Клиент и сервер отправляют друг другу сообщения ChangeCipherSpec, которые указывают на то, что они готовы использовать согласованный набор шифров и сеансовые ключи для защиты данных. Затем они отправляют друг другу сообщения Finished, которые содержат MAC от всех предыдущих сообщений в хэндшейке. Это служит для подтверждения того, что хэндшейк прошел успешно и без вмешательства. Если MAC совпадают, то TLS соединение установлено и обе стороны могут начать обмен данными.

### Порядок работы HTTP-протокола

1. Клиент вводит адрес веб-сайта или переходит по ссылке в своём браузере. Это называется URL (Uniform Resource Locator) и состоит из протокола (например, http), домена (например, bing.com) и пути к ресурсу (например, /search).
2. Клиент формирует и отправляет запрос на сервер. Запрос содержит метод (например, GET), URL, версию протокола (например, HTTP/1.1) и дополнительные заголовки (например, User-Agent, Accept-Language и т. д.), которые передают информацию о клиенте и его предпочтениях.
3. Запрос направляется на сервер либо напрямую, либо через промежуточные узлы, называемые прокси. Прокси могут выполнять различные функции, такие как кэширование, фильтрация или балансировка нагрузки.
4. Сервер получает запрос, обрабатывает его и формирует ответ. Ответ содержит статус (например, 200 OK), версию протокола, заголовки (например, Content-Type, Content-Length и т. д.), которые передают информацию о сервере и его ресурсах, и тело ответа (например, HTML-код веб-страницы).
5. Клиент получает ответ и отображает результат. Если ответ содержит ссылки на другие ресурсы (например, изображения или скрипты), то клиент повторяет шаги 2-5 для каждого из них.

### Код состояния

состоит из трёх цифр, которые относятся к одному из пяти классов:

- 1xx: Информационные. Это промежуточные ответы, которые указывают, что сервер получил запрос и продолжает его обработку. Например, код 100 Continue означает, что клиент может продолжать отправлять данные, а код 101 Switching Protocols означает, что сервер переключается на другой протокол по запросу клиента.
- 2xx: Успешные. Это положительные ответы, которые указывают, что запрос был успешно выполнен и получен нужный результат. Например, код 200 OK означает, что сервер вернул запрошенный ресурс, а код 201 Created означает, что сервер создал новый ресурс по запросу клиента.
- 3xx: Перенаправления. Это ответы, которые указывают, что запрошенный ресурс находится по другому адресу и клиенту нужно перейти по новому URL. Например, код 301 Moved Permanently означает, что ресурс был перемещён навсегда и клиент должен использовать новый URL в будущем, а код 302 Found означает, что ресурс временно доступен по другому URL.
- 4xx: Ошибки клиента. Это ответы, которые указывают, что запрос содержит ошибку или неверные данные со стороны клиента. Например, код 400 Bad Request означает, что запрос имеет неправильный формат или синтаксис, а код 401 Unauthorized означает, что клиент не имеет права доступа к запрашиваемому ресурсу.
- 5xx: Ошибки сервера. Это ответы, которые указывают, что на сервере произошла ошибка при обработке запроса. Например, код 500 Internal Server Error означает, что сервер столкнулся с неожиданной проблемой и не смог выполнить запрос, а код 503 Service Unavailable означает, что сервер временно недоступен из-за перегрузки или технических работ.